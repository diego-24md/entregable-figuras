<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Entrenar modelo de tri√°ngulos</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js"></script>
  </head>
  <body>
    
    <center><h1>¬°Entrenamiento de figuras!</h1></center>

    <script>
      let totalImages = 38;
      let imagesLoaded = 0;

      let acutanguloA = [];
      let acutanguloB = [];
      let trianguloA = [];
      let trianguloB = [];
      let trianguloC = [];
      let trianguloD = [];

      let shapeClassifier;

      // Canvas y dibujo
      let canvas;
      let drawing = false;
      let resultP;

      function setup() {
        // Crear canvas de dibujo
        canvas = createCanvas(300, 300);
        background(255);
        canvas.mousePressed(() => (drawing = true));
        canvas.mouseReleased(() => (drawing = false));

        // Bot√≥n para clasificar
        let predictButton = createButton("Clasificar Tri√°ngulo");
        predictButton.mousePressed(clasificarDibujo);

        // Mostrar resultado
        resultP = createP(
          'Dibuja un tri√°ngulo y haz clic en "Clasificar Tri√°ngulo".'
        );

        // Cargar im√°genes
        for (let i = 0; i < totalImages; i++) {
          let index = nf(i + 1, 3, 0);
          cargarImagen(`data/AcutanguloA${index}.png`, acutanguloA, i);
          cargarImagen(`data/AcutanguloB${index}.png`, acutanguloB, i);
          cargarImagen(`data/TrianguloRectanguloA${index}.png`, trianguloA, i);
          cargarImagen(`data/TrianguloRectanguloB${index}.png`, trianguloB, i);
          cargarImagen(`data/TrianguloRectanguloC${index}.png`, trianguloC, i);
          cargarImagen(`data/TrianguloRectanguloD${index}.png`, trianguloD, i);
        }
      }

      function draw() {
        if (drawing) {
          stroke(0);
          strokeWeight(2);
          line(pmouseX, pmouseY, mouseX, mouseY);
        }
      }

      function cargarImagen(ruta, arrayDestino, indice) {
        loadImage(
          ruta,
          (img) => {
            arrayDestino[indice] = img;
            imagesLoaded++;
            if (imagesLoaded === totalImages * 6) {
              entrenarModelo();
            }
          },
          (err) => {
            console.error(`‚ùå Error al cargar: ${ruta}`, err);
          }
        );
      }

      function entrenarModelo() {
        let options = {
          inputs: [64, 64, 4],
          task: "imageClassification",
          debug: true,
        };

        shapeClassifier = ml5.neuralNetwork(options);

        for (let i = 0; i < totalImages; i++) {
          a√±adirDato(acutanguloA[i], "AcutanguloA");
          a√±adirDato(acutanguloB[i], "AcutanguloB");
          a√±adirDato(trianguloA[i], "RectanguloA");
          a√±adirDato(trianguloB[i], "RectanguloB");
          a√±adirDato(trianguloC[i], "RectanguloC");
          a√±adirDato(trianguloD[i], "RectanguloD");
        }

        shapeClassifier.normalizeData();
        shapeClassifier.train({ epochs: 50 }, () => {
          console.log("‚úÖ Entrenamiento finalizado.");
        });
      }

      function a√±adirDato(imagen, etiqueta) {
        imagen.resize(64, 64);
        shapeClassifier.addData({ image: imagen }, { label: etiqueta });
      }

      function clasificarDibujo() {
        let img = get(); // Captura del canvas
        img.resize(64, 64);

        shapeClassifier.classify({ image: img }, (err, results) => {
          if (err) {
            console.error(err);
            resultP.html("‚ùå Error al clasificar.");
            return;
          }
          let etiqueta = results[0].label;
          let confianza = nf(results[0].confidence * 100, 2, 2);
          resultP.html(
            `üîç Predicci√≥n: <strong>${etiqueta}</strong><br>üìä Confianza: ${confianza}%`
          );
        });
      }
    </script>
  </body>
</html>
